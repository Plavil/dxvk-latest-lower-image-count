#!/bin/bash

export WINEDEBUG=-all

dlls_dir=`dirname $(readlink -f $0)`
build_arch='@arch@'

if [ ! -f "$dlls_dir/d3d11.dll" ] || [ ! -f "$dlls_dir/dxgi.dll" ]; then
    echo "d3d11.dll or dxgi.dll not found in $dlls_dir"
    exit 1
fi

if [ $build_arch == "x86_64" ]; then
    wine=wine64
else
    wine=wine
fi

if [ -z "$WINEPREFIX" ]; then
    echo "WINEPREFIX is not set, continue? (y/N)"
    read continue
    if [ "$continue" != "y" ] && [ "$continue" != "Y" ]; then
      exit 1
    fi
fi
unix_sys_path="$($wine winepath -u 'C:\windows\system32')"

function removeOverride {
    echo "$1:"
    echo -n '    [1/2] Removing override... '
    wine reg add 'HKEY_CURRENT_USER\Software\Wine\DllOverrides' /v $1 /d builtin /f
    if [ ! $? ]; then
        exit 1
    fi
    local dll="$unix_sys_path/$1.dll"
    echo -n '    [2/2] Removing link... '
    if [ -h "$dll" ]; then
        rm "$dll"
        if [ "$?" == "0" ]; then
            echo "Done."
        fi
    else
        echo "'$dll' is not a link or doesn't exist."
    fi
}

function checkOverride {
    echo "$1:"
    echo -n '    [1/2] Checking override... '
    local ovr="$(wine reg query 'HKEY_CURRENT_USER\Software\Wine\DllOverrides' /v $1)"
    if [[ $ovr == *native* ]] && ! [[ $ovr == *builtin,native* ]]; then
        echo -e '\e[1;32mOK\e[0m.'
    else
        echo -e '\e[1;31mnot set\e[0m.'
    fi
    echo -n "    [2/2] Checking link to $1.dll... "
    if [ "$(readlink -f "$unix_sys_path/$1.dll")" == "$(readlink -f "$dlls_dir/$1.dll")" ]; then
        echo -e '\e[1;32mOK\e[0m.'
    else
        echo -e '\e[1;31mnot set\e[0m.'
    fi
}

function createOverride {
    echo "$1:"
    echo -n '    [1/2] Creating override... '
    wine reg add 'HKEY_CURRENT_USER\Software\Wine\DllOverrides' /v $1 /d native /f
    echo -n "    [2/2] Creating link to $1.dll... "
    ln -sf "$dlls_dir/$1.dll" "$unix_sys_path/$1.dll"
    if [ $? ]; then
        echo "Done."
    fi
}

case "$1" in
reset)
    echo -n '[1/2] '
    removeOverride d3d11
    echo -n '[2/2] '
    removeOverride dxgi
    ;;
check)
    echo -n '[1/2] '
    checkOverride d3d11
    echo -n '[2/2] '
    checkOverride dxgi
    ;;
'')
    echo -n '[1/2] '
    createOverride d3d11
    echo -n '[2/2] '
    createOverride dxgi
    ;;
*)
    echo "Unrecognized option: $1"
    echo "Usage: $0 [reset|check]"
    exit 1
    ;;
esac
